{% extends "base.html" %}

{% block title %}Take Attendance - Face Recognition Attendance System{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h2><i class="fas fa-check-circle me-2"></i>Take Attendance</h2>
        <p class="text-muted">{{ subject.subject_name }} - Section {{ section.name }}</p>
    </div>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back
    </a>
</div>

<div class="row">
    <!-- QR Code Section -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-qrcode me-2"></i>QR Code Scanner</h5>
            </div>
            <div class="card-body text-center">
                <div id="qr-reader-teacher" style="width: 100%;"></div>
                <div id="qr-result-teacher" class="mt-3" style="display: none;">
                </div>
                <p class="text-muted small mt-2">Point camera at student's QR code</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Instructions</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0 small">
                    <li>Use QR Scanner or Face Recognition</li>
                    <li>Click "Start Camera" to activate scanner</li>
                    <li>Point at student's QR code OR face</li>
                    <li>Attendance auto-marked as present</li>
                    <li>Or manually mark using buttons below</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Face Recognition Section -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-user-check me-2"></i>Face Recognition</h5>
            </div>
            <div class="card-body text-center">
                <div id="face-reader" style="width: 100%; background: #000; border-radius: 4px;">
                    <img src="{{ url_for('video_feed') }}" id="video-feed" style="width: 100%; max-width: 320px; border-radius: 4px;" />
                </div>
                <p class="text-muted small mt-2">Face recognition active</p>
            </div>
        </div>
    </div>
    
    <!-- Student List -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Students</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Roll No</th>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td>{{ student.roll_number }}</td>
                                <td><code>{{ student.student_id }}</code></td>
                                <td>{{ student.first_name }} {{ student.last_name }}</td>
                                <td>
                                    {% set attendance = attendance_dict.get(student.id) %}
                                    {% if attendance %}
                                        {% if attendance.status == 'present' %}
                                            <span class="badge badge-present">Present</span>
                                        {% elif attendance.status == 'absent' %}
                                            <span class="badge badge-absent">Absent</span>
                                        {% elif attendance.status == 'late' %}
                                            <span class="badge badge-late">Late</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">Not Marked</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-success me-1" data-student="{{ student.id }}" data-status="present" onclick="markAttendance(this)">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger me-1" data-student="{{ student.id }}" data-status="absent" onclick="markAttendance(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-warning" data-student="{{ student.id }}" data-status="late" onclick="markAttendance(this)">
                                        <i class="fas fa-clock"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for quick attendance marking -->
<form id="quick-attendance-form" action="{{ url_for('manual_attendance') }}" method="POST" style="display:none;">
    <input type="hidden" name="subject_id" value="{{ subject.id }}">
    <input type="hidden" name="student_id" id="qa-student-id">
    <input type="hidden" name="status" id="qa-status">
</form>

<!-- QR Code Scanner -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
function markAttendance(btn) {
    var studentId = btn.getAttribute('data-student');
    var status = btn.getAttribute('data-status');
    document.getElementById('qa-student-id').value = studentId;
    document.getElementById('qa-status').value = status;
    document.getElementById('quick-attendance-form').submit();
}

// QR Scanner for teachers
var html5QrcodeScanner;

document.addEventListener('DOMContentLoaded', function() {
    initTeacherScanner();
});

function initTeacherScanner() {
    html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader-teacher", 
        { fps: 10, qrbox: { width: 200, height: 200 } },
        false
    );
    
    html5QrcodeScanner.render(onTeacherScanSuccess, onTeacherScanFailure);
}

function onTeacherScanSuccess(decodedText, decodedResult) {
    try {
        var data = JSON.parse(decodedText);
        
        if (data.type === 'student_qr' && data.student_id) {
            // Auto-mark present
            var formData = new FormData();
            formData.append('subject_id', '{{ subject.id }}');
            formData.append('student_id', data.student_id);
            formData.append('status', 'present');
            
            fetch('/teacher/manual-attendance', {
                method: 'POST',
                body: formData
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var resultDiv = document.getElementById('qr-result-teacher');
                if (data.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>' + data.message + '</div>';
                    // Reload page after short delay
                    setTimeout(function() { location.reload(); }, 1000);
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-circle me-2"></i>' + data.message + '</div>';
                }
                resultDiv.style.display = 'block';
            })
            .catch(function(error) {
                var resultDiv = document.getElementById('qr-result-teacher');
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>Error: ' + error.message + '</div>';
                resultDiv.style.display = 'block';
            });
        }
    } catch (e) {
        // Ignore invalid QR codes
    }
}

function onTeacherScanFailure(error) {
    // Ignore scan failures
}
</script>
{% endblock %}
