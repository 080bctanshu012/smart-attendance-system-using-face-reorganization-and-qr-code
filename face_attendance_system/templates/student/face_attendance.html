{% extends "base.html" %}

{% block title %}Face Attendance - Face Recognition Attendance System{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="fas fa-user-check me-2"></i>Face Recognition Attendance</h2>
    <p class="text-muted">Mark your attendance using face recognition at KEC</p>
</div>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-camera me-2"></i>Camera Feed</h5>
            </div>
            <div class="card-body">
                <div class="video-container">
                    <video id="video-feed" autoplay playsinline></video>
                    <canvas id="capture-canvas" style="display:none;"></canvas>
                </div>
                <div class="mt-3 text-center">
                    <button id="start-camera" class="btn btn-primary me-2">
                        <i class="fas fa-power-off me-2"></i>Start Camera
                    </button>
                    <button id="capture-btn" class="btn btn-success" disabled>
                        <i class="fas fa-camera me-2"></i>Capture & Verify
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Result</h5>
            </div>
            <div class="card-body">
                <div id="result-container" class="text-center" style="min-height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                    <p class="text-muted">Start camera and capture your face to mark attendance</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Instructions</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Ensure good lighting conditions</li>
                    <li>Face the camera directly</li>
                    <li>Remove glasses or hats if possible</li>
                    <li>Keep a neutral expression</li>
                    <li>Stay within the frame</li>
                    <li>You must be at <strong>Kantipur Engineering College</strong> campus</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Your Location</h5>
            </div>
            <div class="card-body">
                <p><strong>Latitude:</strong> <span id="lat" class="text-muted">Allow location access...</span></p>
                <p><strong>Longitude:</strong> <span id="lng" class="text-muted">Allow location access...</span></p>
                <p><strong>Distance from campus:</strong> <span id="distance" class="text-muted">Waiting...</span></p>
                <button type="button" class="btn btn-sm btn-primary mt-2" onclick="refreshLocation()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh Location
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let video = document.getElementById('video-feed');
let canvas = document.getElementById('capture-canvas');
let startBtn = document.getElementById('start-camera');
let captureBtn = document.getElementById('capture-btn');
let resultContainer = document.getElementById('result-container');

let stream = null;
let userLat = null;
let userLng = null;
let isLocationVerified = false;
const classroomLat = 27.6635;
const classroomLng = 85.3161;
const allowedRadius = 200; // meters

// Get location on page load
function getLocation() {
    if (navigator.geolocation) {
        // Request high accuracy
        const options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        };
        
        navigator.geolocation.getCurrentPosition(function(position) {
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;
            document.getElementById('lat').textContent = userLat.toFixed(6);
            document.getElementById('lng').textContent = userLng.toFixed(6);
            
            var distance = getDistanceFromLatLonInMeters(userLat, userLng, classroomLat, classroomLng);
            var isWithin = distance <= allowedRadius;
            isLocationVerified = isWithin;
            
            document.getElementById('distance').innerHTML = 
                distance.toFixed(0) + ' meters ' + 
                (isWithin ? '<span class="badge bg-success">Within campus!</span>' : '<span class="badge bg-danger">Outside campus!</span>');
            
            if (!isWithin) {
                alert('Warning: You are outside the campus! You must be within ' + allowedRadius + 'm of KEC to mark attendance.');
            }
        }, function(error) {
            handleLocationError(error);
        }, options);
    } else {
        document.getElementById('lat').textContent = 'Not supported';
        document.getElementById('lng').textContent = 'Not supported';
        document.getElementById('distance').innerHTML = '<span class="badge bg-danger">Location required!</span>';
    }
}

function handleLocationError(error) {
    let errorMsg = 'Location error: ';
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMsg += 'Location access denied. Please enable location permissions and refresh.';
            break;
        case error.POSITION_UNAVAILABLE:
            errorMsg += 'Location unavailable. Please check your GPS.';
            break;
        case error.TIMEOUT:
            errorMsg += 'Location request timed out. Please try again.';
            break;
        default:
            errorMsg += error.message;
    }
    document.getElementById('lat').textContent = 'Error';
    document.getElementById('lng').textContent = 'Error';
    document.getElementById('distance').innerHTML = '<span class="badge bg-danger">' + errorMsg + '</span>';
}

// Refresh location
function refreshLocation() {
    getLocation();
}

// Calculate distance
function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
    var R = 6371000; // Earth's radius in meters
    var dLat = (lat2 - lat1) * Math.PI / 180;
    var dLon = (lon2 - lon1) * Math.PI / 180;
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Auto-get location on page load
window.addEventListener('load', function() {
    getLocation();
});

startBtn.addEventListener('click', async () => {
    if (!window.isSecureContext) {
        alert('Camera access requires HTTPS or localhost. Please access via http://localhost:5000 or use HTTPS.');
        return;
    }
    
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        startBtn.disabled = true;
        captureBtn.disabled = false;
    } catch (err) {
        console.error('Camera error:', err);
        if (err.name === 'NotAllowedError') {
            alert('Camera access denied. Please allow camera permissions.');
        } else if (err.name === 'NotFoundError') {
            alert('No camera found.');
        } else {
            alert('Error accessing camera: ' + err.message);
        }
    }
});

captureBtn.addEventListener('click', () => {
    // Check location first
    if (!userLat || !userLng) {
        resultContainer.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Location not available. Please enable location services.</div>';
        return;
    }
    
    var distance = getDistanceFromLatLonInMeters(userLat, userLng, classroomLat, classroomLng);
    if (distance > allowedRadius) {
        resultContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>You are not within KEC campus! Distance: ' + Math.round(distance) + 'm (must be within ' + allowedRadius + 'm)</div>';
        return;
    }
    
    // Capture image
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    let imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Show loading
    resultContainer.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Verifying face...</div>';
    
    // Stop camera
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    startBtn.disabled = false;
    captureBtn.disabled = true;
    
    // Send to server
    fetch('/student/verify-face', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            image_data: imageData,
            subject_id: 1  // Default to first subject - can be made selectable
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.already_marked) {
                resultContainer.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-circle me-2"></i>' + data.message + '</div>';
            } else {
                resultContainer.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>' + data.message + '</div>';
            }
        } else {
            resultContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>' + data.message + '</div>';
        }
    })
    .catch(error => {
        resultContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error.message + '</div>';
    });
});

// Initialize location on page load (already done via window.addEventListener)
</script>
{% endblock %}
